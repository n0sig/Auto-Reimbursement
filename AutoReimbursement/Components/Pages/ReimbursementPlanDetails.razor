@page "/reimbursement-plans/{PlanId:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using AutoReimbursement.Data
@using AutoReimbursement.Services
@using AutoReimbursement.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ILogger<ReimbursementPlanDetails> Logger
@inject IInvoiceStorageService StorageService
@rendermode InteractiveServer

@attribute [Authorize]

<PageTitle>@(plan?.Name ?? "Plan Details")</PageTitle>

@if (plan == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-3">
        <a href="/reimbursement-plans" class="btn btn-secondary">
            <span class="bi bi-arrow-left"></span> Back to Plans
        </a>
    </div>

    <h1>@plan.Name</h1>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert alert-info">@statusMessage</div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="card mb-4">
        <div class="card-body">
            <p class="card-text"><strong>Created:</strong> @plan.CreatedDate.ToString("yyyy-MM-dd HH:mm")</p>
            <p class="card-text"><strong>Total Invoices:</strong> @plan.Invoices.Count</p>
            <p class="card-text"><strong>Total Amount:</strong> $@plan.Invoices.Sum(i => i.Amount).ToString("N2")</p>
        </div>
    </div>

    <div class="mb-4">
        <InvoiceForm Model="newInvoiceModel" 
                     OnSubmit="AddInvoice" 
                     AvailablePayers="availablePayers"
                     FormName="addInvoice" />
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">Invoices (@plan.Invoices.Count)</h3>
        </div>
        <div class="card-body">
            @if (plan.Invoices.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Serial #</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Payer</th>
                                <th>Items</th>
                                <th>PDF</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in plan.Invoices.OrderByDescending(i => i.Date))
                            {
                                <tr>
                                    <td>@(invoice.Serial ?? "-")</td>
                                    <td>@invoice.Type</td>
                                    <td>@(invoice.Description ?? "-")</td>
                                    <td>$@invoice.Amount.ToString("N2")</td>
                                    <td>@(invoice.Date?.ToString("yyyy-MM-dd") ?? "-")</td>
                                    <td>@(invoice.Payer?.UserName ?? "Deleted user")</td>
                                    <td>@invoice.InvoiceItems.Count items</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(invoice.PdfFilePath))
                                        {
                                            <a href="/@invoice.PdfFilePath" target="_blank" class="btn btn-sm btn-info">
                                                <span class="bi bi-file-pdf"></span> View
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick="() => ViewInvoiceDetails(invoice.Id)">
                                            <span class="bi bi-eye"></span> Details
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteInvoice(invoice.Id)">
                                            <span class="bi bi-trash"></span> Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Total</th>
                                <th>$@plan.Invoices.Sum(i => i.Amount).ToString("N2")</th>
                                <th colspan="5"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <p>No invoices yet. Add one above to get started!</p>
            }
        </div>
    </div>

    @if (selectedInvoice != null && showInvoiceDetails)
    {
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Invoice Details - @(selectedInvoice.Description ?? selectedInvoice.Type.ToString())</h5>
                        <button type="button" class="btn-close" @onclick="CloseInvoiceDetails"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Serial Number:</strong> @(selectedInvoice.Serial ?? "-")</p>
                                <p><strong>Type:</strong> @selectedInvoice.Type</p>
                                <p><strong>Description:</strong> @(selectedInvoice.Description ?? "-")</p>
                                <p><strong>Date:</strong> @(selectedInvoice.Date?.ToString("yyyy-MM-dd") ?? "-")</p>
                                <p><strong>Payer:</strong> @(selectedInvoice.Payer?.UserName ?? "Deleted user")</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> $@selectedInvoice.Amount.ToString("N2")</p>
                                <p><strong>Notes:</strong> @(selectedInvoice.Notes ?? "-")</p>
                                @if (!string.IsNullOrEmpty(selectedInvoice.PdfFilePath))
                                {
                                    <p>
                                        <strong>PDF:</strong> 
                                        <a href="/@selectedInvoice.PdfFilePath" target="_blank" class="btn btn-sm btn-info">
                                            <span class="bi bi-file-pdf"></span> View PDF
                                        </a>
                                    </p>
                                }
                            </div>
                        </div>

                        @if (selectedInvoice.InvoiceItems.Any())
                        {
                            <h6>Invoice Items:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Specification</th>
                                            <th>Unit</th>
                                            <th>Amount</th>
                                            <th>Price (No Tax)</th>
                                            <th>Tax</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in selectedInvoice.InvoiceItems)
                                        {
                                            <tr>
                                                <td>@item.Name</td>
                                                <td>@(item.Specification ?? "-")</td>
                                                <td>@(item.Unit ?? "-")</td>
                                                <td>@(item.Amount?.ToString("N2") ?? "-")</td>
                                                <td>$@item.Pretax.ToString("N2")</td>
                                                <td>$@item.Tax.ToString("N2")</td>
                                                <td>$@((item.Pretax + item.Tax).ToString("N2"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="7" class="text-end">Total:</th>
                                            <th>$@selectedInvoice.InvoiceItems.Sum(i => i.Pretax + i.Tax).ToString("N2")</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No items in this invoice.</p>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseInvoiceDetails">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int PlanId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private string? currentUserId;
    private ReimbursementPlan? plan;
    private string? statusMessage;
    private string? errorMessage;
    private Invoice? selectedInvoice;
    private bool showInvoiceDetails = false;
    private List<ApplicationUser>? availablePayers;

    [SupplyParameterFromForm]
    private InvoiceForm.InvoiceFormModel newInvoiceModel { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var currentUser = await UserManager.GetUserAsync(user);
                if (currentUser != null)
                {
                    currentUserId = currentUser.Id;
                    await LoadPlan();
                    await LoadAvailablePayers();
                }
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(currentUserId))
        {
            await LoadPlan();
        }
    }

    private async Task LoadPlan()
    {
        plan = await DbContext.ReimbursementPlans
            .Include(p => p.Invoices)
                .ThenInclude(i => i.InvoiceItems)
            .Include(p => p.Invoices)
                .ThenInclude(i => i.Payer)
            .FirstOrDefaultAsync(p => p.Id == PlanId);
    }

    private async Task LoadAvailablePayers()
    {
        // Load all non-admin users
        availablePayers = await DbContext.Users
            .Where(u => !u.IsAdministrator)
            .OrderBy(u => u.UserName)
            .ToListAsync();
    }

    private async Task AddInvoice(InvoiceForm.InvoiceFormModel model)
    {
        try
        {
            if (plan == null)
            {
                errorMessage = "Plan not found.";
                return;
            }

            var invoice = new Invoice
            {
                ReimbursementPlanId = plan.Id,
                Serial = model.SerialNumber,
                Description = model.Description,
                Amount = model.Amount,
                Date = model.Date,
                Type = Enum.Parse<InvoiceType>(model.Type),
                Notes = model.Notes,
                PdfFilePath = model.PdfFilePath,
                PayerId = model.PayerId
            };

            // Add invoice items
            foreach (var itemModel in model.Items)
            {
                invoice.InvoiceItems.Add(new InvoiceItem
                {
                    Name = itemModel.Name,
                    Specification = itemModel.Specification,
                    Unit = itemModel.Unit,
                    Amount = itemModel.Quantity,
                    Pretax = itemModel.Pretax,
                    Tax = itemModel.Tax
                });
            }

            DbContext.Invoices.Add(invoice);
            await DbContext.SaveChangesAsync();

            statusMessage = "Invoice added successfully.";
            errorMessage = null;
            newInvoiceModel = new InvoiceForm.InvoiceFormModel();
            
            await LoadPlan();
            Logger.LogInformation("Invoice added to plan {PlanId}", plan.Id);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding invoice: {ex.Message}";
            statusMessage = null;
            Logger.LogError(ex, "Error adding invoice");
        }
    }

    private async Task DeleteInvoice(int invoiceId)
    {
        try
        {
            var invoice = await DbContext.Invoices
                .Include(i => i.InvoiceItems)
                .FirstOrDefaultAsync(i => i.Id == invoiceId);
                
            if (invoice != null)
            {
                // Delete PDF file if exists
                if (!string.IsNullOrEmpty(invoice.PdfFilePath))
                {
                    try
                    {
                        await StorageService.DeletePdfAsync(invoice.PdfFilePath);
                    }
                    catch (Exception ex)
                    {
                        Logger.LogWarning(ex, "Error deleting PDF file for invoice {InvoiceId}", invoiceId);
                    }
                }

                DbContext.Invoices.Remove(invoice);
                await DbContext.SaveChangesAsync();

                statusMessage = "Invoice deleted successfully.";
                errorMessage = null;
                
                await LoadPlan();
                Logger.LogInformation("Invoice deleted: {InvoiceId}", invoiceId);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting invoice: {ex.Message}";
            statusMessage = null;
            Logger.LogError(ex, "Error deleting invoice");
        }
    }

    private async Task ViewInvoiceDetails(int invoiceId)
    {
        selectedInvoice = await DbContext.Invoices
            .Include(i => i.InvoiceItems)
            .Include(i => i.Payer)
            .FirstOrDefaultAsync(i => i.Id == invoiceId);
        
        showInvoiceDetails = true;
    }

    private void CloseInvoiceDetails()
    {
        showInvoiceDetails = false;
        selectedInvoice = null;
    }
}
