@using AutoReimbursement.Data
@using AutoReimbursement.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IBulkInvoiceService BulkInvoiceService
@inject ILogger<BulkInvoiceUpload> Logger

<div class="card mb-4">
    <div class="card-header">
        <h3 class="mb-0">One-Click Add - Bulk Upload Invoices</h3>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">Select Payer (required for all invoices) *</label>
            <select @bind="selectedPayerId" class="form-control" disabled="@isUploading">
                <option value="">-- Select Payer --</option>
                @if (AvailablePayers != null)
                {
                    @foreach (var payer in AvailablePayers)
                    {
                        <option value="@payer.Id">@payer.UserName</option>
                    }
                }
            </select>
            @if (!string.IsNullOrEmpty(validationMessage))
            {
                <div class="text-danger mt-2">@validationMessage</div>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Select PDF Invoices (multiple files)</label>
            <InputFile OnChange="HandleFileSelection" accept=".pdf" multiple class="form-control" disabled="@string.IsNullOrEmpty(selectedPayerId)" />
            <small class="form-text text-muted">
                @if (string.IsNullOrEmpty(selectedPayerId))
                {
                    <span class="text-warning">Please select a payer first to enable file selection</span>
                }
                else
                {
                    <span>Select multiple PDF files - upload starts automatically</span>
                }
            </small>
        </div>

        @if (isUploading)
        {
            <div class="alert alert-info">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Processing invoices... You can continue to add more files.
            </div>
        }

        @if (allUploadProgress.Any())
        {
            <div class="mt-3">
                <h5>Upload Progress</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Status</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var progress in allUploadProgress.OrderByDescending(p => p.StartTime))
                            {
                                <tr class="@GetRowClass(progress.Status)">
                                    <td>@progress.FileName</td>
                                    <td>
                                        @if (progress.Status == BulkUploadStatus.Uploading)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        else if (progress.Status == BulkUploadStatus.Extracting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        @GetStatusBadge(progress.Status)
                                    </td>
                                    <td>@progress.Message</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (GetCompletedBatchesCount() > 0)
                {
                    <div class="alert alert-secondary mt-2">
                        <strong>Summary:</strong> 
                        @GetTotalSuccessCount() succeeded, @GetTotalFailedCount() failed 
                        (from @GetCompletedBatchesCount() batch@(GetCompletedBatchesCount() > 1 ? "es" : ""))
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int ReimbursementPlanId { get; set; }

    [Parameter]
    public List<ApplicationUser>? AvailablePayers { get; set; }

    [Parameter]
    public EventCallback OnInvoicesAdded { get; set; }

    private string selectedPayerId = "";
    private string validationMessage = "";
    private bool isUploading = false;
    private List<BulkUploadProgressExtended> allUploadProgress = new();
    private int batchCounter = 0;

    private class BulkUploadProgressExtended
    {
        public string FileName { get; set; } = string.Empty;
        public BulkUploadStatus Status { get; set; }
        public string Message { get; set; } = string.Empty;
        public DateTime StartTime { get; set; }
        public int BatchId { get; set; }
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        validationMessage = "";
        
        if (string.IsNullOrEmpty(selectedPayerId))
        {
            validationMessage = "Please select a payer first.";
            return;
        }

        var files = e.GetMultipleFiles(50);
        if (!files.Any())
        {
            return;
        }

        // Read files into memory
        var filesData = new List<FileData>();
        foreach (var file in files)
        {
            try
            {
                await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB limit
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                
                filesData.Add(new FileData
                {
                    FileName = file.Name,
                    Data = memoryStream.ToArray()
                });
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error reading file {FileName}", file.Name);
                validationMessage = $"Failed to read file {file.Name}: {ex.Message}";
                return;
            }
        }

        // Start upload automatically
        if (filesData.Any())
        {
            _ = StartBulkUploadAsync(filesData);
        }
    }

    private async Task StartBulkUploadAsync(List<FileData> filesData)
    {
        isUploading = true;
        var currentBatchId = ++batchCounter;
        var currentBatchProgress = new List<BulkUploadProgressExtended>();

        // Initialize progress for all files in this batch
        foreach (var file in filesData)
        {
            var progressItem = new BulkUploadProgressExtended
            {
                FileName = file.FileName,
                Status = BulkUploadStatus.Pending,
                Message = "Waiting to process...",
                StartTime = DateTime.Now,
                BatchId = currentBatchId
            };
            currentBatchProgress.Add(progressItem);
            allUploadProgress.Add(progressItem);
        }

        await InvokeAsync(StateHasChanged);

        try
        {
            await BulkInvoiceService.ProcessBulkUploadAsync(
                filesData,
                selectedPayerId,
                ReimbursementPlanId,
                progress => UpdateProgress(progress, currentBatchProgress)
            );

            // Notify parent component to reload
            if (OnInvoicesAdded.HasDelegate)
            {
                await OnInvoicesAdded.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during bulk upload");
            // Mark all pending items as failed
            foreach (var item in currentBatchProgress.Where(p => p.Status == BulkUploadStatus.Pending || p.Status == BulkUploadStatus.Uploading || p.Status == BulkUploadStatus.Extracting))
            {
                item.Status = BulkUploadStatus.Failed;
                item.Message = $"Error: {ex.Message}";
            }
        }
        finally
        {
            isUploading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void UpdateProgress(BulkUploadProgress progress, List<BulkUploadProgressExtended> batchProgress)
    {
        var existing = batchProgress.FirstOrDefault(p => p.FileName == progress.FileName);
        if (existing != null)
        {
            existing.Status = progress.Status;
            existing.Message = progress.Message;
        }
        
        // Force UI update
        InvokeAsync(StateHasChanged);
    }

    private int GetCompletedBatchesCount()
    {
        return allUploadProgress
            .Where(p => p.Status == BulkUploadStatus.Added || p.Status == BulkUploadStatus.Failed)
            .Select(p => p.BatchId)
            .Distinct()
            .Count();
    }

    private int GetTotalSuccessCount()
    {
        return allUploadProgress.Count(p => p.Status == BulkUploadStatus.Added);
    }

    private int GetTotalFailedCount()
    {
        return allUploadProgress.Count(p => p.Status == BulkUploadStatus.Failed);
    }

    private string GetStatusBadge(BulkUploadStatus status)
    {
        return status switch
        {
            BulkUploadStatus.Pending => "Pending",
            BulkUploadStatus.Uploading => "Uploading",
            BulkUploadStatus.Extracting => "Extracting",
            BulkUploadStatus.Added => "✓ Added",
            BulkUploadStatus.Failed => "✗ Failed",
            _ => status.ToString()
        };
    }

    private string GetRowClass(BulkUploadStatus status)
    {
        return status switch
        {
            BulkUploadStatus.Added => "table-success",
            BulkUploadStatus.Failed => "table-danger",
            _ => ""
        };
    }
}
